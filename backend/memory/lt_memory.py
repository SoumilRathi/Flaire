import datetime
from sentence_transformers import SentenceTransformer
from mongodb import client
from numpy import dot
from numpy.linalg import norm
import numpy as np


model = SentenceTransformer('all-mpnet-base-v2')


class LongTermMemory:
    def __init__(self):
        """Initialize long-term memory as dictionaries of sentences"""
        self.episodic = [];
        self.semantic = [];
        self.procedural = [];

    def get_best_practices(self, query):
        """Get the best practices relating to a given query"""

        db = client.css
        coll = db.best_practices

        segment_embedding = model.encode(query);

        segment_embedding = segment_embedding.tolist();

        resultsList = [];

        results = coll.aggregate([
            {
                "$vectorSearch": {
                    "index": "embedding",
                    "path": "embedding",
                    "queryVector": segment_embedding,
                    "limit": 6,
                    "numCandidates": 41
                }
            }
        ])

        for result in results:
            resultsList.append(result['text']);

        return resultsList;

    def get_project_preferences(self, components):
        """Get the project preferences relating to a given components"""

        """
        Alright so we have a decent list of components. 

        The way we can do this is: 
    
        For each component: 
            Take the name from each component. 
            Find the project preferences within 0.5 similarity of that name
                Do you want to link to firebase alr? Yep. Actually that takes some work on the frontend as well so lets ignore that for now. 
            Add all the project preferences to a list. 
            Remove duplicates. 
            Return the list. 
        """

        all_project_preferences = [{
            "text": "All basic buttons should be red in color",
            "embedding": [0.009858882986009121, -0.046058375388383865, -0.0013751311926171184, 0.01996276155114174, -0.0030334715265780687, -0.012185763567686081, 0.01668408513069153, 0.03148224204778671, -0.019276879727840424, -0.029961492866277695, -0.06418658792972565, -0.021056000143289566, -0.03430531173944473, -0.001544114900752902, -0.003402174450457096, 0.005412771832197905, -0.0010461476631462574, 0.057388246059417725, 0.02282816730439663, 0.03685662895441055, -0.04549318179488182, 0.017173627391457558, -0.01642506942152977, -0.013798038475215435, 0.024040989577770233, -0.00046903439215384424, -0.02899603173136711, 0.023479733616113663, -0.040249332785606384, 0.02866111882030964, 0.01783827692270279, 0.05893632769584656, -0.06805633008480072, -0.013634301722049713, 1.3048015716776717e-06, -0.015435600653290749, -0.010912838391959667, -0.07936684787273407, 0.039851099252700806, 0.00534516666084528, 0.004985159263014793, 0.01224549114704132, 0.04563675820827484, 0.012555060908198357, 0.014145497232675552, 0.017082257196307182, 0.0066088405437767506, 0.12030062079429626, 0.00020292522094678134, -0.053234077990055084, -0.014381336979568005, -0.0009932236280292273, 0.040532223880290985, -0.026528894901275635, 0.05588289350271225, 0.02734232135117054, -0.015157602727413177, 0.004649131093174219, 0.07807257026433945, -0.0010825193021446466, -0.03273363038897514, 0.0034647334832698107, 0.03497638925909996, 0.06101779267191887, -0.0740857720375061, -0.05513628572225571, -0.023327231407165527, -0.022498665377497673, 0.008866256102919579, 0.04621311277151108, -0.059730131179094315, -0.030889546498656273, -0.01773233525454998, 0.05179626867175102, 0.015167361125349998, -0.04177834838628769, 0.013669833540916443, 0.006831543520092964, -0.030531473457813263, -0.014669868163764477, -0.01363062672317028, -0.03365275263786316, -0.0011207382194697857, 0.03742753341794014, 0.0594879575073719, -0.008194410242140293, -0.014941626228392124, -0.034464575350284576, -0.005992220714688301, -0.022830655798316002, 0.00041871852590702474, 0.03591879829764366, -0.004117938689887524, -0.07980000972747803, -0.02611580491065979, -0.010733377188444138, -0.0147400526329875, 0.01650429144501686, 0.025626083835959435, -0.011985819786787033, -0.018958842381834984, 0.06401371210813522, 0.01679481565952301, -0.02742375247180462, -0.05767226591706276, 0.025960758328437805, 0.0333869569003582, 0.005653399508446455, -0.017132272943854332, -0.027584370225667953, -0.027154741808772087, 0.0024194486904889345, 0.01340308878570795, -0.008240844123065472, 0.05634235590696335, 0.0005072520580142736, 0.0018308460712432861, 0.008695069700479507, -0.01493730116635561, -0.056578248739242554, 0.038538672029972076, -0.021226393058896065, -0.019168272614479065, -0.04533209651708603, 0.00251146056689322, -0.06173417717218399, 0.03492480888962746, -0.0023602682631462812, -0.08260447531938553, -0.03134241700172424, -0.003929851111024618, -0.02049364149570465, -0.009349663741886616, 0.004305466543883085, -0.040233906358480453, 0.010092519223690033, -0.011759036220610142, 0.06298884004354477, 0.05696624517440796, -0.0013534462777897716, 0.04462131857872009, 0.04560668393969536, -0.02718537300825119, -0.002639943500980735, -0.05515582114458084, 0.0068670883774757385, 0.017970461398363113, 0.03942501172423363, -0.0037113255821168423, -0.0440342016518116, -0.003321732161566615, -0.04457688704133034, -0.00546305300667882, 0.01967739686369896, -0.024061409756541252, 0.025461824610829353, 0.0038975279312580824, 0.028258157894015312, -0.05794406309723854, -0.0020599530544131994, 0.016743509098887444, -0.04274625703692436, 0.026782777160406113, 0.039378970861434937, -0.05584985390305519, 0.04237162694334984, -0.0030885597225278616, -0.07184905558824539, -0.01454768143594265, -0.04169353470206261, 0.037406016141176224, -0.089134082198143, -0.0024659486953169107, -0.030095521360635757, -0.04322775453329086, -0.052777908742427826, 0.020174017176032066, -0.01299359928816557, -0.029477374628186226, -0.08177679032087326, 0.00047422864008694887, 0.0098390132188797, -0.02309546060860157, -0.007848020642995834, 0.010188320651650429, 0.03664727136492729, -0.03125453367829323, -0.004217289853841066, 0.006571140605956316, 0.03099025785923004, -0.05882437527179718, 0.03620956838130951, 0.002375698881223798, 0.012607798911631107, -0.025448709726333618, -0.044030558317899704, -0.0022714713122695684, -0.024331824854016304, -0.007862826809287071, -0.005374466069042683, 0.01046289037913084, -0.019220838323235512, -0.036999911069869995, -0.024730520322918892, -0.016686568036675453, -0.027602506801486015, 0.03953034430742264, -0.04805556684732437, 0.045071810483932495, -0.002492091851308942, 0.03278224170207977, 0.030921129509806633, 0.027060553431510925, -0.05243655666708946, -0.11196594685316086, -0.0037996761966496706, -0.006127980072051287, -0.02602231316268444, -0.03117498569190502, -0.023915788158774376, 0.026744794100522995, -0.007725454401224852, -0.023349307477474213, 0.02747252769768238, 0.05799449607729912, -0.015396625734865665, 0.0005034340429119766, -0.002089721616357565, 0.038896672427654266, -0.004772855434566736, -0.008866810239851475, 0.013432452455163002, -0.04975113645195961, 0.0035991512704640627, -0.006789540406316519, 0.03541082143783569, 0.027654213830828667, -0.04722743481397629, -0.01532153133302927, -0.020909667015075684, -0.012749839574098587, 0.08716601133346558, -0.008844143711030483, 0.054411619901657104, 0.006301863119006157, 0.007837394252419472, 0.05270441994071007, -0.028480809181928635, -0.013541724532842636, 0.01728873699903488, -0.006744020152837038, -0.0023421410005539656, -0.05441693961620331, -0.05951322987675667, -0.0018335796194151044, 0.03670104593038559, -0.06118042767047882, 0.056215763092041016, -0.08051884919404984, 0.010708419606089592, 0.0046813166700303555, -0.014337149448692799, -0.007751603610813618, 0.04006735980510712, -0.004289727192372084, -0.0031201450619846582, 0.06903469562530518, 0.0070107546634972095, 0.024820106104016304, -0.014141631312668324, -0.014665700495243073, 0.06862596422433853, -0.025304215028882027, 0.019787387922406197, -0.04375477507710457, 0.042724043130874634, 0.04702404513955116, 0.04714306816458702, 0.016133900731801987, -0.04326474666595459, -0.06537974625825882, -0.046094946563243866, -0.0509335920214653, -0.038698866963386536, 0.010419636964797974, -0.04024973511695862, 0.005147597752511501, 0.013261581771075726, 0.07413200289011002, 0.0402495451271534, 0.009251854382455349, 0.03520418331027031, 0.032182030379772186, -0.1050872951745987, 0.0038794507272541523, -0.0023723591584712267, -0.00995215680450201, 0.055409371852874756, -0.003905532881617546, -0.0291498601436615, -0.023720378056168556, 0.0005976406973786652, -0.008008752018213272, 0.013978366740047932, -0.03310113772749901, -0.018758578225970268, 0.008031989447772503, -0.016657540574669838, 0.04504963755607605, 0.05381668731570244, 0.03598544001579285, 0.014955010265111923, 0.02945881336927414, -0.062001824378967285, -0.012787651270627975, 0.03726767748594284, -0.01316804252564907, -0.017165428027510643, 0.042425867170095444, 0.027518659830093384, -0.010739126242697239, -0.036294933408498764, 0.00824868306517601, -0.01710500754415989, -0.006803027354180813, -0.004658866208046675, -0.03749370202422142, 0.008784329518675804, -0.021676145493984222, 0.027834773063659668, 0.02525610290467739, -0.0448826365172863, 0.0519743375480175, -0.023974746465682983, 0.004195390269160271, -0.005708614829927683, 0.05127091705799103, 0.04763179272413254, 0.008618742227554321, -0.00011286752123851329, -0.020793922245502472, -0.03858466446399689, -0.05069747939705849, -0.04299904406070709, 0.020677806809544563, -0.023769330233335495, -0.02402377873659134, -0.002113617956638336, -0.014678692445158958, 0.04850689694285393, 0.04530191048979759, 0.019118715077638626, 0.04114573076367378, -0.007838512770831585, 0.033914584666490555, -0.044979989528656006, -0.039506565779447556, -0.03295649215579033, -0.009870464913547039, -0.02970327064394951, 0.020261026918888092, -0.036347776651382446, 0.003259218530729413, -0.032091520726680756, -0.013231516815721989, -0.020574310794472694, 0.034414444118738174, 0.0643458217382431, 0.003827271517366171, -0.09300019592046738, -0.014127086848020554, 0.039472319185733795, 0.01018308661878109, 0.029945414513349533, -0.0636167824268341, -0.0029709620866924524, 0.025035865604877472, 0.03285704553127289, 0.03357594460248947, 0.05727219954133034, -0.01619935967028141, 0.008660384453833103, -0.01158318854868412, -0.02565399557352066, -0.008470170199871063, -0.025060052052140236, 0.0015812780475243926, 0.021393857896327972, -0.03502340242266655, -0.0665154829621315, -0.017484545707702637, -0.07278624922037125, -0.045824311673641205, 0.15632738173007965, -0.0006417371332645416, 0.039020832628011703, 0.02455955743789673, 0.03677814453840256, -0.06064494326710701, -0.0028693305794149637, -0.02564600296318531, -0.043166257441043854, -0.06212533637881279, 0.002284576650708914, 0.05732899159193039, -0.033586535602808, 0.026009412482380867, -0.022614745423197746, -0.01498402375727892, 0.011788708157837391, 0.07688826322555542, 0.01770717278122902, 0.015049192123115063, 0.05867942050099373, -0.03629770874977112, 0.006406774278730154, -0.03492421656847, -0.03164086118340492, -0.03285672888159752, 0.06686455756425858, -0.016307130455970764, 0.01950276456773281, -0.015138856135308743, -0.012244557030498981, -0.05119653791189194, -0.013101737946271896, -0.010903263464570045, 0.02393086440861225, 0.04363321512937546, -0.013644768856465816, -0.01813705451786518, -0.013552270829677582, -0.007918909192085266, 0.09034381806850433, -0.04048417508602142, -0.07417050749063492, -0.03320598602294922, -0.10795175284147263, -0.012177514843642712, 0.006485946010798216, 0.016002004966139793, -0.04751593619585037, -0.00993635319173336, -0.010353539139032364, -0.01758405938744545, -0.042695723474025726, -0.01911957561969757, 0.05312301963567734, 0.006334321573376656, -0.007957704365253448, -0.03486436977982521, -0.027352111414074898, -0.04513278603553772, -0.023186830803751945, -0.03595079481601715, -0.007171039469540119, -0.013062020763754845, 0.10406160354614258, 0.06732935458421707, 0.01434087660163641, 0.001314486493356526, 0.008410116657614708, -0.07863600552082062, 0.004188844934105873, -0.04489170387387276, -0.05267629027366638, 0.004170130006968975, 0.04792794957756996, 0.04273791238665581, 0.01720387674868107, 0.0016108636045828462, 0.013692017644643784, -0.01477627083659172, -0.0012727630091831088, 0.03870686516165733, 0.007488762494176626, 0.01228350680321455, -0.030048979446291924, 0.025187522172927856, -0.024589432403445244, -0.021110402420163155, 0.03743411600589752, 0.019271813333034515, 0.08010875433683395, -0.008040796965360641, 0.01033622957766056, 0.004611059091985226, 0.004641927778720856, 0.004634406883269548, 0.0865764245390892, 0.004875506274402142, -0.0014663712354376912, -0.00028726711752824485, -0.03172838315367699, -0.017612500116229057, -0.04218253120779991, 0.04392334446310997, 0.035058703273534775, 0.02403896115720272, 0.004274982959032059, 0.020992260426282883, -0.02564377896487713, -0.06077190116047859, 0.09748715162277222, -0.004271369427442551, -0.034171413630247116, 0.050455473363399506, 0.02776436135172844, -0.029752179980278015, -0.007919893600046635, 0.054427433758974075, 0.0097345020622015, -0.028725629672408104, -0.03637200593948364, 0.02770441211760044, 0.03349138796329498, 0.024889972060918808, 0.007536109071224928, -0.04694733768701553, 0.029205486178398132, -0.008362138643860817, -0.005717563442885876, -0.011223623529076576, 0.052854541689157486, 0.02886388823390007, 0.051708947867155075, 0.007158598862588406, -0.050901975482702255, 0.010871372185647488, -0.004860502202063799, -0.0002250494435429573, 0.039642658084630966, -0.03188832849264145, 0.014266514219343662, 0.03776249289512634, 0.022948648780584335, 0.06598779559135437, 0.010601448826491833, 0.02276248298585415, 0.012617836706340313, -0.04131470248103142, -0.018512936308979988, 0.001508442685008049, -0.009559236466884613, 0.013876310549676418, 0.04965594783425331, 0.020362315699458122, -0.03665793314576149, -0.027696140110492706, 0.028221463784575462, 0.02609959989786148, 0.028276383876800537, -0.13020449876785278, -0.004938666708767414, -0.028929855674505234, -4.401432885142662e-33, 0.06640222668647766, 0.013822219334542751, -0.08020712435245514, -0.021307799965143204, 0.02853953279554844, 0.07239488512277603, 0.00432994170114398, -0.011773359961807728, -0.017754310742020607, 0.016668548807501793, 0.011600149795413017, -0.023325901478528976, 0.002333418931812048, 0.02258714661002159, -0.01816103793680668, 0.004979768302291632, 0.020888784900307655, 0.038019441068172455, 0.04943548142910004, -0.008681590668857098, -0.019900090992450714, -0.05328062176704407, 0.03545468673110008, -0.028517862781882286, -0.1332997828722, 0.039463646709918976, -0.04993821308016777, 0.059676408767700195, -0.01617712900042534, 0.03253992646932602, 0.0033516513649374247, 0.004622637294232845, 0.0007720006979070604, -0.00799714308232069, -0.0006551186670549214, 0.06899123638868332, 0.04655495285987854, -0.017368655651807785, 0.003950160928070545, -0.00892198272049427, -0.024103587493300438, 0.010125252418220043, 0.05420643463730812, -0.03506125882267952, 0.06097187101840973, 0.026134688407182693, 0.0005957318935543299, -0.037040963768959045, 0.05185023322701454, -0.0045157382264733315, 0.009065913036465645, -0.008205574005842209, -0.00779689522460103, 0.025128182023763657, -0.03541247919201851, 0.03447863832116127, 0.030065147206187248, -0.04197752848267555, -0.062034834176301956, -0.013563481159508228, 0.003486998612061143, 0.012872057966887951, -0.02844148315489292, 0.09161672741174698, -0.0010118057252839208, 0.005830387584865093, -0.06535565853118896, 0.07751080393791199, -0.0469835102558136, 0.034961897879838943, 0.03769565001130104, 0.03640754520893097, 0.004669121466577053, 0.06375633180141449, 0.006981054786592722, 0.01944497972726822, 0.007178897969424725, -0.007705887779593468, 0.05050474777817726, 0.0465632788836956, -0.020535428076982498, 0.04328406602144241, -0.043030910193920135, 0.009680003859102726, -0.028084296733140945, 0.05509242042899132, -0.00041317095747217536, -0.013479182496666908, 0.03261924535036087, -0.008028789423406124, 0.012636792846024036, -0.027226431295275688, 0.018589923158288002, 0.00776221789419651, -0.060098979622125626, 0.07957776635885239, -0.012619494460523129, -0.011717882938683033, -0.019520310685038567, -0.070529505610466, -0.02671295776963234, 0.01428760215640068, -0.019428204745054245, 0.014063061214983463, -0.017339644953608513, 0.018345147371292114, -0.03503257408738136, -0.022821815684437752, -0.03183459863066673, 0.026497304439544678, 0.008420569822192192, -0.0217825248837471, -0.015053467825055122, -0.0213655773550272, -0.038180865347385406, -0.021586913615465164, -0.012319332920014858, 0.024520304054021835, -0.020441319793462753, -0.046534404158592224, 0.03450356051325798, 0.001549226581119001, 0.013158611953258514, 0.009218838065862656, -0.02306319586932659, -0.02752242051064968, -0.038629788905382156, -0.009762933477759361, 0.027845920994877815, 0.05578066036105156, 0.002955264411866665, -0.07461360841989517, 2.0692648661224666e-07, 0.004814800340682268, -0.06684501469135284, 0.016060076653957367, -0.007563017308712006, -0.0012648791307583451, 0.041865892708301544, 0.03297083079814911, -0.02181202918291092, 0.035916704684495926, -0.028589418157935143, -0.023350853472948074, 0.027060288935899734, -0.008520553819835186, 0.02892850525677204, 0.024246683344244957, -0.04888839274644852, 0.001499511650763452, 0.02720939926803112, 0.02800000086426735, 0.0011250508250668645, 0.0820041075348854, 0.016556333750486374, 0.1088394895195961, 0.038395851850509644, 0.01577463559806347, 0.0029898970387876034, -0.038098353892564774, -0.031136207282543182, 0.07444118708372116, 0.029958901926875114, -0.040333639830350876, 0.005372222512960434, -0.010692449286580086, -0.0014862454263493419, 0.011329508386552334, -0.028105974197387695, 0.015143473632633686, 0.022933481261134148, -0.013311183080077171, -0.021704556420445442, 0.0054349214769899845, -0.00496238749474287, 0.020443957298994064, -0.010506919585168362, 0.018372345715761185, 0.0019026614027097821, 0.02442135661840439, -0.005703609902411699, 0.042545631527900696, 0.010163526982069016, 0.04208088666200638, -0.024323774501681328, 0.007826140150427818, 0.019083507359027863, -0.02702466771006584, 0.0002570883370935917, -0.07518403977155685, 0.032590631395578384, 0.0073422328568995, 0.04039360582828522, -0.006170379463583231, -0.010513544082641602, 0.05492342635989189, 0.10683857649564743, 0.021081233397126198, 0.033556412905454636, 0.024493154138326645, 1.18957996442863e-34, -0.015980014577507973, -0.02782365493476391, 0.05806582793593407, -0.019330909475684166, 0.07158255577087402, 0.00549799669533968, -0.05587004870176315, 0.0007549097645096481, 0.023291535675525665, 0.002005597809329629, 0.016111375764012337]
        }]

        # this is an array of maps, with each object having a string and an embedding.
        selected_project_preferences = []

        for component in components:
            component_name = component["name"]
            component_embedding = model.encode(component_name)

            # Vectorize the similarity calculation
            similarities = np.dot(np.array([pref["embedding"] for pref in all_project_preferences]), component_embedding.T)
            norms = np.linalg.norm(np.array([pref["embedding"] for pref in all_project_preferences]), axis=1) * np.linalg.norm(component_embedding)
            cos_sims = similarities / norms

            # Append text from objects for which embeddings are a match (similarity >= 0.5)
            selected_project_preferences.extend([pref["text"] for pref, sim in zip(all_project_preferences, cos_sims) if sim >= 0.5])

        # Remove duplicates while preserving order
        selected_project_preferences = list(dict.fromkeys(selected_project_preferences))

        return selected_project_preferences



        # this will typically be an array of maps, with each object being a string and an embedding.
            # NO????????????????????????
    
    def store_memory(self, memory_type, memory):
        """Store a memory in the appropriate category"""
        if memory_type == 'episodic':
            self.episodic.append({
                "memory": memory,
                "timestamp": datetime.now()
            })
        elif memory_type == 'semantic':
            self.semantic.append({
                "memory": memory,
                "embedding": model.encode(memory)
            })

            # print("MEMORY STORED IN SEMANTIC MEMORY");

            # print(self.semantic);
        elif memory_type == 'procedural':
            self.procedural.append(memory)
        else:
            raise ValueError("Invalid memory type. Must be 'episodic', 'semantic', or 'procedural'.")


    def retrieve_memory(self, memory_type, memory_request):
        """Retrieve a memory from long term memory"""

        if memory_type == "semantic":

            # Get the embedding of the memory request
            memory_request_embedding = model.encode(memory_request)

            # Create a dictionary to store the similarity scores for each memory
            similarity_scores = {}

            # Calculate the similarity scores for each memory in the semantic memory
            for memory in self.semantic:
                cos_sim = (memory_request_embedding @ memory["embedding"].T) / (norm(memory_request_embedding)*norm(memory["embedding"]))
                similarity_scores[memory["memory"]] = cos_sim

            # Filter the memories with similarity scores greater than or equal to 0.5
            filtered_memories = {memory: score for memory, score in similarity_scores.items() if score >= 0.5}

            # Get the top 5 memories with the highest similarity scores
            top_memories = sorted(filtered_memories.items(), key=lambda x: x[1], reverse=True)[:5]

            # Return the top memories
            return top_memories
        
        else:
            return []

        




